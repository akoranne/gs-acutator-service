resource_types:
- name: meta
  type: docker-image
  source:
    repository: swce/metadata-resource
    tag: latest
    username: ((docker-user))
    password: ((docker-passwd))

- name: keyval
  type: docker-image
  source:
    repository: swce/keyval-resource
    tag: latest
    username: ((docker-user))
    password: ((docker-passwd))

resources:
- name: metadata
  type: meta
- name: keyval
  type: keyval
- name: service-repo
  type: git
  source:
    uri: {{git-url}}
    branch: {{git-branch}}
    # username: ((git-username))
    # password: ((git-passwd))

jobs:
# - name: build
#   plan:
#     - get: meta
#     - task: build
#       file: tools/tasks/build/task.yml
#     - put: keyval
#       params:
#         file: keyvalout/keyval.properties
- name: build-service
  plan:
  - get: metadata
  - get: keyval
  - get: service-repo
    trigger: true
  - task: create-archive
    file: service-repo/ci/tasks/build-service/task.yml
  - put: keyval
    params:
      file: keyvalout/keyval.properties

- name: test-meta
  plan:
    - get: keyval
    - task: test-meta
      file: tools/tasks/prod-deploy/task.yml
#       #file: tools/tasks/prod-deploy/task.yml
#       config:
#         platform: linux
#         image_resource:
#           type: docker-image
#           source:
#             repository: busybox
#         outputs:
#           - name: build_output
#         run:
#           path: sh
#           args:
#             - -exc
#             - |
